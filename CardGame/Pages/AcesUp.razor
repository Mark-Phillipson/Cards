@inject IJSRuntime JS
@page "/acesup"
@using CardGame.Models
@using CardGame.Services
<PageTitle>Aces Up</PageTitle>
<div style="display: flex; flex-direction: column; align-items: center;" @ref="mainDivRef">
@code {
    private ElementReference mainDivRef;
    private DotNetObjectReference<AcesUp>? dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("AcesUpKeyboard.init", dotNetRef);
        }
    }

    [JSInvokable]
    public void OnKeyShortcut(string key)
    {
        if (key == "n" || key == "N")
        {
            NewGame();
        }
        else if (key == "d" || key == "D")
        {
            DealNext();
        }
    }

    public void Dispose()
    {
        if (dotNetRef != null)
        {
            JS.InvokeVoidAsync("AcesUpKeyboard.dispose");
            dotNetRef.Dispose();
        }
    }
}
    <div style="display: flex; flex-direction: row; align-items: center; justify-content: space-between; width: 100%; max-width: 700px; margin-bottom: 12px;">
        <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-start;">
            <button class="acesup-btn" @onclick="NewGame">New Game</button>
            <button class="acesup-btn" style="margin-top: 8px;" @onclick="GoHome">Home</button>
            <button class="acesup-btn" style="margin-top: 8px;" @onclick="ShowRulesModal">Rules</button>
        </div>
@if (showRulesModal)
{
    <AcesUpRulesModal OnClose="HideRulesModal" />
}
@code {
    private bool showRulesModal = false;
    private void ShowRulesModal() => showRulesModal = true;
    private void HideRulesModal() => showRulesModal = false;
    [Inject] NavigationManager? Nav { get; set; }
    void GoHome() => Nav?.NavigateTo("/");
    // ...existing code...
}
        <div style="flex: 1; text-align: center; font-size: 1.3em;">
            <span>Aces Up</span>
        </div>
        <div style="flex: 1; text-align: right;">
            <div class="stock" @onclick="DealNext" style="display: inline-block; cursor: @(CanDeal ? "pointer" : "default");">
                @if (Stock.Count > 0)
                {
                    <img src="/cards/Cards-Reverse.svg" alt="stock" style="height:120px; border: 2px solid black; vertical-align: middle;" />
                }
                else
                {
                    <img src="/cards/Cards-Blank.svg" alt="no stock" style="height:120px; border: 2px solid black; vertical-align: middle;" />
                }
            </div>
        </div>
    </div>

    <div style="margin-bottom: 8px; font-size: 1.1em; color: #333;">Discarded: @Discarded</div>
    <div style="margin-bottom: 8px;">@Message</div>
    <div class="tableau" style="display: flex; flex-direction: row; gap: 24px; justify-content: center; width: 100%; max-width: 700px;">
        @if (Tableau != null)
        {
            @for (int i = 0; i < Tableau.Count; i++)
            {
                var localIndex = i;
                <div class="pile" style="position: relative; width: 110px; height: 180px; display: flex; flex-direction: column; align-items: center;">
                    @if (Tableau[i] != null && Tableau[i].Count > 0)
                    {
                        var cards = Tableau[i].ToArray();
                        // Reverse the array so the top card is rendered last (on top)
                        for (int j = cards.Length - 1; j >= 0; j--)
                        {
                            var card = cards[j];
                            var isTop = (j == 0); // Now index 0 is the top card
                            var overlayStyle = $"position: absolute; top: {(cards.Length - 1 - j) * 36}px; left: 0; width: 110px; height: 160px; {(isTop ? "z-index: 2;" : "z-index: 1;")}";
                            if (isTop)
                            {
                                // Only the top card is checked for discardable/canMoveToEmpty
                                bool discardable = GetDiscardableCards().Any(x => x.pileIndex == localIndex && x.card.Rank == card.Rank && x.card.Suit == card.Suit && x.card.Value == card.Value);
                                bool canMoveToEmpty = Tableau[i].Count > 0 && Tableau.Any(p => p != null && p.Count == 0) && !discardable;
                                var imgStyle = $"height:160px; border: 2px solid black; width: 110px; box-shadow: {(discardable ? "0 0 8px 2px #ff9800" : (canMoveToEmpty ? "0 0 8px 2px #2196f3" : "none"))}; cursor: {(discardable || canMoveToEmpty ? "pointer" : "default")};";
                                <div style="@overlayStyle">
                                    <img src="@card.ImageUrl" alt="@card.Rank of @card.Suit"
                                         style="@imgStyle"
                                         @onclick="() => OnCardClick(localIndex)" @onclick:stopPropagation />
                                </div>
                            }
                            else
                            {
                                var imgStyle = "height:160px; border: 2px solid black; width: 110px; mask-image: linear-gradient(to bottom, black 0 36px, transparent 36px 160px); -webkit-mask-image: linear-gradient(to bottom, black 0 36px, transparent 36px 160px); opacity: 1;";
                                <div style="@overlayStyle">
                                    <img src="@card.ImageUrl" alt="@card.Rank of @card.Suit"
                                         style="@imgStyle" />
                                </div>
                            }
                        }
                    }
                    else
                    {
                        <div style="height:160px; width:110px; border:2px solid black; display:flex; align-items:center; justify-content:center; background:white;"></div>
                    }
                </div>
            }
        }
    </div>
    <style>
        .acesup-btn {
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 28px;
            font-size: 1.1em;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            margin-bottom: 4px;
        }
        .acesup-btn:hover, .acesup-btn:focus {
            background: linear-gradient(90deg, #1565c0 0%, #1e88e5 100%);
            transform: translateY(-2px) scale(1.04);
            outline: none;
        }
        .tableau {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .pile {
            cursor: pointer;
        }

        .stock {
            margin: 20px auto;
            width: fit-content;
        }

        .toast-message {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 1.2rem;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            opacity: 0.95;
            pointer-events: none;
        }
        .tableau {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }

    .pile {
        cursor: pointer;
    }

    .stock {
        margin: 20px auto;
        width: fit-content;
    }

    .toast-message {
        position: fixed;
        top: 40px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 16px 32px;
        border-radius: 8px;
        font-size: 1.2rem;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        opacity: 0.95;
        pointer-events: none;
    }

    </style>
</div>

    