@inject IJSRuntime JS
@page "/acesup"
@using CardGame.Models
@using CardGame.Services
@using Microsoft.AspNetCore.Components.Web

<PageTitle>Aces Up</PageTitle>
<div class="acesup-background-wrapper">
    <div class="acesup-content-container" @ref="mainDivRef">
    <div style="display: flex; flex-direction: row; align-items: center; justify-content: space-between; width: 100%; max-width: 700px; margin-bottom: 12px;">
        <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-start;">
            <button class="acesup-btn" accesskey="n" style="width: 150px; min-width: 150px; max-width: 150px;" @onclick="ShowNewGameConfirmButtons">New <span style="font-size:0.85em;opacity:0.7;">(Alt+N)</span></button>
            <button class="acesup-btn" accesskey="u" style="margin-top: 8px; width: 150px; min-width: 150px; max-width: 150px;" @onclick="Undo" disabled="@(!CanUndo)">Undo <span style="font-size:0.85em;opacity:0.7;">(Alt+U)</span></button>
            <button class="acesup-btn" accesskey="h" style="margin-top: 8px; width: 150px; min-width: 150px; max-width: 150px;" @onclick="GoHome">Home <span style="font-size:0.85em;opacity:0.7;">(Alt+H)</span></button>
            <button class="acesup-btn" accesskey="r" style="margin-top: 8px; width: 150px; min-width: 150px; max-width: 150px;" @onclick="ShowRulesModal">Rules <span style="font-size:0.85em;opacity:0.7;">(Alt+R)</span></button>
            <div style="margin-top: 16px; width: 150px;">
                <label style="display: flex; align-items: center; cursor: pointer; color: #333; font-size: 0.95em; font-weight: 600;">
                    <input type="checkbox" @bind="autoPlayEnabled" @bind:after="OnToggleAutoPlay" style="margin-right: 8px; cursor: pointer;" />
                    <span>Auto-play on hover</span>
                </label>
                <div aria-live="polite" aria-atomic="true" style="position: absolute; left: -10000px;">@autoPlayStatusMessage</div>
            </div>
        </div>
@if (showRulesModal)
{
    <AcesUpRulesModal OnClose="HideRulesModal" />
}

@code {
    private ElementReference mainDivRef;
    private DotNetObjectReference<AcesUp>? dotNetRef;
    private bool showRulesModal = false;
    private bool showNewGameConfirmButtons = false;
    
    // Hover-to-click state
    private bool autoPlayEnabled = false;
    private Dictionary<int, int> hoverProgress = new();
    private string autoPlayStatusMessage = "";
    
    private void ShowNewGameConfirmButtons()
    {
        showNewGameConfirmButtons = true;
        StateHasChanged();
    }
    private void ConfirmNewGame()
    {
        showNewGameConfirmButtons = false;
        ShowDebugMessage("Yes button clicked");
        NewGame();
    }

    private void HideNewGameConfirmButtons()
    {
        showNewGameConfirmButtons = false;
        ShowDebugMessage("No button clicked");
    }
    private void ShowRulesModal() => showRulesModal = true;
    private void HideRulesModal() => showRulesModal = false;

    private string debugMessage = "";
    private System.Timers.Timer? debugTimer;
    private void ShowDebugMessage(string msg)
    {
        debugMessage = msg;
        StateHasChanged();
        debugTimer?.Dispose();
        debugTimer = new System.Timers.Timer(2000);
        debugTimer.Elapsed += (s, e) => {
            debugMessage = "";
            debugTimer?.Dispose();
            InvokeAsync(StateHasChanged);
        };
        debugTimer.Start();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("AcesUpKeyboard.init", dotNetRef);
            await JS.InvokeVoidAsync("AcesUpBackground.setRandomBackground");
            await JS.InvokeVoidAsync("initAcesUpHover", dotNetRef, autoPlayEnabled);
        }
        else if (autoPlayEnabled)
        {
            // Refresh hover listeners after DOM updates (wrap in try-catch for safety)
            try
            {
                await JS.InvokeVoidAsync("refreshAcesUpHoverListeners");
            }
            catch
            {
                // Function may not exist in cached version - will work after hard refresh
            }
        }
        
        // No modal focus trap needed
    }

    [Inject] NavigationManager? Nav { get; set; }
    void GoHome() => Nav?.NavigateTo("/");

    [JSInvokable]
    public async Task OnKeyShortcut(string key)
    {
        switch (key.ToLower())
        {
            case "d":
                if (CanDeal)
                {
                    DealNext();
                }
                else
                {
                    ShowDebugMessage("Cannot deal: you must discard or move cards first.");
                }
                break;
            case "1":
            case "2":
            case "3":
            case "4":
                int col = int.Parse(key) - 1;
                if (Tableau != null && col >= 0 && col < Tableau.Count)
                {
                    OnCardClick(col);
                }
                break;
            case "n":
                ShowNewGameConfirmButtons();
                break;
        }
        await InvokeAsync(StateHasChanged);
    }
}
    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.25);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-dialog {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.18);
            padding: 32px 32px 24px 32px;
            min-width: 320px;
            max-width: 90vw;
        }
    </style>
        <div style="flex: 1; text-align: center; font-size: 1.3em;">
            <span>Aces Up</span>
        </div>
        @if (showNewGameConfirmButtons)
        {
            <div style="margin: 0 auto 18px auto; display: flex; flex-direction: column; align-items: center; max-width: 400px; background: #f7f7f7; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 18px 24px;">
                <div style="margin-bottom: 16px; font-size: 1.15em; font-weight: 500; text-align: center; color: #333;">Start a new game?<br /><span style="font-size: 0.98em; font-weight: 400; color: #666;">Your current progress will be lost.</span></div>
                <div style="display: flex; gap: 24px; justify-content: center;">
                    <button class="acesup-btn" type="button" tabindex="0" aria-label="Cancel and keep current game" style="width: 90px; min-width: 80px; max-width: 120px; font-size: 1.08em;" @onclick="HideNewGameConfirmButtons">No</button>
                    <button class="acesup-btn" type="button" tabindex="0" aria-label="Start new game and lose progress" style="width: 90px; min-width: 80px; max-width: 120px; font-size: 1.08em;" @onclick="ConfirmNewGame">Yes</button>
                </div>
            </div>
        }
        <div style="flex: 1; text-align: right;">
            <div class="stock" @onclick="DealNext" style="display: inline-block; cursor: @(CanDeal ? "pointer" : "default"); position: relative;" data-pile-index="deal" data-hoverable="@(CanDeal ? "true" : "false")">
                @if (Stock.Count > 0)
                {
                    <img src="/cards/Cards-Reverse.svg" alt="stock" style="height:160px; width:110px; border:2px solid black; background:white; vertical-align: middle;" />
                    <div style="position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%); font-size: 0.85em; opacity: 0.7; white-space: nowrap;">Press D to Deal</div>
                    @if (hoverProgress.ContainsKey(-1) && hoverProgress[-1] > 0)
                    {
                        var circumference = 2 * Math.PI * 16;
                        var dashArray = $"{circumference * hoverProgress[-1] / 100} {circumference}";
                        <svg style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none;"
                             width="50" height="50">
                            <circle cx="25" cy="25" r="16"
                                    stroke="#1976d2"
                                    stroke-width="4"
                                    fill="transparent"
                                    style="stroke-dasharray: @dashArray; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dasharray 0.05s linear;" />
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; font-size: 1.2em; font-weight: bold; color: #1976d2; text-shadow: 0 0 3px white, 0 0 3px white, 0 0 3px white;">
                            @hoverProgress[-1]%
                        </div>
                    }
                }
                else
                {
                    <img src="/cards/Cards-Blank.svg" alt="no stock" style="height:160px; width:110px; border:2px solid black; background:white; vertical-align: middle;" />
                }
            </div>
        </div>
    </div>
                                <!-- Removed stray modal Yes button -->
    <div style="margin-bottom: 8px; font-size: 1.1em; color: #333;">Discarded: @Discarded</div>
    <div style="margin-bottom: 8px;">@Message</div>
    @if (!string.IsNullOrEmpty(debugMessage))
    {
        <div style="background:#ff9800;color:#fff;padding:8px 16px;border-radius:6px;box-shadow:0 2px 8px #333;position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:3000;">@debugMessage</div>
    }
    <div class="tableau" style="display: flex; flex-direction: row; gap: 24px; justify-content: center; width: 100%; max-width: 700px;">
        @if (Tableau != null)
        {
            @for (int i = 0; i < Tableau.Count; i++)
            {
                var localIndex = i;
                <div class="pile" style="position: relative; width: 110px; height: 180px; display: flex; flex-direction: column; align-items: center;">
                    <div style="position: absolute; top: -24px; font-size: 0.85em; opacity: 0.7;">Press @(localIndex + 1)</div>
                    @if (Tableau[i] != null && Tableau[i].Count > 0)
                    {
                        var cards = Tableau[i].ToArray();
                        // Reverse the array so the top card is rendered last (on top)
                        for (int j = cards.Length - 1; j >= 0; j--)
                        {
                            var card = cards[j];
                            var isTop = (j == 0); // Now index 0 is the top card
                            var overlayStyle = $"position: absolute; top: {(cards.Length - 1 - j) * 36}px; left: 0; width: 110px; height: 160px; {(isTop ? "z-index: 2;" : "z-index: 1;")}";
                            if (isTop)
                            {
                                // Only the top card is checked for discardable/canMoveToEmpty
                                bool discardable = GetDiscardableCards().Any(x => x.pileIndex == localIndex && x.card.Rank == card.Rank && x.card.Suit == card.Suit && x.card.Value == card.Value);
                                bool canMoveToEmpty = Tableau[i].Count > 0 && Tableau.Any(p => p != null && p.Count == 0) && !discardable;
                                var imgStyle = $"height:160px; border: 2px solid black; width: 110px; background:white; box-shadow: {(discardable ? "0 0 8px 2px #ff9800" : (canMoveToEmpty ? "0 0 8px 2px #2196f3" : "none"))}; cursor: {(discardable || canMoveToEmpty ? "pointer" : "default")};";
                                <div style="@overlayStyle">
                                    <img src="@card.ImageUrl" alt="@card.Rank of @card.Suit"
                                         style="@imgStyle"
                                         data-pile-index="@localIndex"
                                         data-hoverable="true"
                                         @onclick="() => OnCardClick(localIndex)" @onclick:stopPropagation />
                                    @if (hoverProgress.ContainsKey(localIndex) && hoverProgress[localIndex] > 0)
                                    {
                                        var circumference = 2 * Math.PI * 16;
                                        var dashArray = $"{circumference * hoverProgress[localIndex] / 100} {circumference}";
                                        var remainingSeconds = ((100 - hoverProgress[localIndex]) * 2.0 / 100).ToString("F1");
                                        <svg style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none;"
                                             width="50" height="50">
                                            <circle cx="25" cy="25" r="16"
                                                    stroke="#1976d2"
                                                    stroke-width="4"
                                                    fill="transparent"
                                                    style="stroke-dasharray: @dashArray; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dasharray 0.05s linear;" />
                                        </svg>
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; font-size: 1.2em; font-weight: bold; color: #1976d2; text-shadow: 0 0 3px white, 0 0 3px white, 0 0 3px white;">
                                            @hoverProgress[localIndex]%
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                var imgStyle = "height:160px; border: 2px solid black; width: 110px; background:white; mask-image: linear-gradient(to bottom, black 0 36px, transparent 36px 160px); -webkit-mask-image: linear-gradient(to bottom, black 0 36px, transparent 36px 160px); opacity: 1;";
                                <div style="@overlayStyle">
                                    <img src="@card.ImageUrl" alt="@card.Rank of @card.Suit"
                                         style="@imgStyle" />
                                </div>
                            }
                        }
                    }
                    else
                    {
                        <div style="height:160px; width:110px; border:2px solid black; display:flex; align-items:center; justify-content:center; background:transparent;"></div>
                    }
                </div>
            }
        }
    </div>
    <style>
        .acesup-btn {
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 0;
            font-size: 1.1em;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            margin-bottom: 4px;
            text-align: center;
        }
        .acesup-btn:hover, .acesup-btn:focus {
            background: linear-gradient(90deg, #1565c0 0%, #1e88e5 100%);
            transform: translateY(-2px) scale(1.04);
        }
        .acesup-btn:focus {
            outline: 3px solid #ff9800;
            outline-offset: 2px;
            box-shadow: 0 0 0 4px #ffe0b2;
            z-index: 10;
        }
        .acesup-btn:disabled {
            background: linear-gradient(90deg, #bdbdbd 0%, #e0e0e0 100%);
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }
        .acesup-btn:disabled:hover {
            transform: none;
        }
        .tableau {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .pile {
            cursor: pointer;
        }

        .stock {
            margin: 20px auto;
            width: fit-content;
        }

        .toast-message {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 1.2rem;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            opacity: 0.95;
            pointer-events: none;
        }
        .tableau {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }

    .pile {
        cursor: pointer;
    }

    .stock {
        margin: 20px auto;
        width: fit-content;
    }

    .toast-message {
        position: fixed;
        top: 40px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 16px 32px;
        border-radius: 8px;
        font-size: 1.2rem;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        opacity: 0.95;
        pointer-events: none;
    }

    .acesup-background-wrapper {
        min-height: 100vh;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 20px 0;
    }

    .acesup-content-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgba(255, 255, 255, 0.75); /* Increased transparency */
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        max-width: 900px;
        width: 100%;
        margin: 20px auto;
        min-height: 0;
        height: 80vh;
        box-sizing: border-box;
    }

    </style>
    </div>
</div>
    